version: v1.0
name: evaldb
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: lint
    task:
      jobs:
        - name: cppcheck
          commands:
            - checkout
            - install-package cppcheck
            - make cppcheck
        - name: clang tidy
          commands:
            - install-package libjansson-dev clang-tidy clang
            - checkout
            - make clangtidy
  - name: test
    task:
      jobs:
        - name: unit tests
          commands:
            - checkout
            - install-package libjansson-dev
            - change-go-version 1.11
            - go get -v -d -t ./...
            - make
            - make test
        - name: valgrind
          commands:
            - checkout
            - install-package valgrind libjansson-dev
            - make luaval
            - make valgrind
